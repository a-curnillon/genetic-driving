<!DOCTYPE html>
<html>

<head>

  <title>Genetic Driving</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="style.css">

</head>

<body class="centered">

  <table class="centered">

    <thead>
      <tr>
        <th colspan="12">
          <h1><span id="A">•</span> Project <span id="T">•</span> Genetic <span id="C">•</span> Driving <span
              id="G">•</span></h1>
        </th>
      </tr>
    </thead>

    <tbody>
      <tr>
        <td class="colored" colspan="4">Author :</td>
        <td class="centered" colspan="8">
          <div id="author"></div>
        </td>
      </tr>
      <tr>
        <td class="colored" colspan="4">Date :</td>
        <td class="centered" colspan="8">
          <div id="date"></div>
        </td>
      </tr>
      <tr>
        <td class="colored centered" colspan="12">
          Parameters <button id="buttonParam" onclick="clickParam()" type="button" value="down">&darr;</button>
        </td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered mid-colored paramMenu" colspan="4"><b>Play</b> / Pause</td>
        <td class="centered mid-colored paramMenu" colspan="8"><b>Normal</b> / debug</td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered paramMenu" colspan="4">
          <input id="buttonPlayPause" type="checkbox" checked="true" onclick="clickPlayPause()"></input>
        </td>
        <td class="centered paramMenu" colspan="8">
          <input type="checkbox" checked="true" onclick="clickNormalDebug()"></input>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered mid-colored paramMenu" colspan="12">Mutation Rate</td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered paramMenu" colspan="12">
          <input type="range" min="0" step="0.01" max="1" value="0.2" class="slider" id="sliderMutation"
            onchange="slideChange()"><br>
          <span id="sliderValue">0.2</span>
        </td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered mid-colored paramMenu" colspan="12">Number per Generation</td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered paramMenu" colspan="12">
          <input type="number" id="carNumber" min="1" value="50" onchange="carNumberChange()">
        </td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered mid-colored paramMenu" colspan="12">Fitness Mode</td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered paramMenu" colspan="12">
          <select list="fitnessMode" onchange="fitnessModeChange()" id="fitnessMode">
            <option>normalized fitness</option>
            <option>rank</option>
          </select>
        </td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered mid-colored paramMenu" colspan="12">Parents Selection</td>
      </tr>
      <tr class="paramMenuRow">
        <td class="centered paramMenu" colspan="12">
          <select list="parentsSelection" onchange="parentsModeChange()" id="parentsMode">
            <option>best of the previous generation</option>
            <option>best of all time</option>
          </select>
        </td>
      </tr>
      <tr>
        <td colspan="12" style="margin: 0%; padding: 0%;">
          <div class="row">
            <div class="column">
              <table class="invisible">
                <tbody>
                  <tr>
                    <td class="colored centered" style="height: 25px;">Simulation</td>
                  </tr>
                  <tr>
                    <td class="centered no-margin" style="height: 460px; width: auto;">
                      <div id="sketch-holder"></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="column">
              <table class="invisible">
                <tbody>
                  <tr>
                    <td class="colored centered" colspan="12" style="height: 25px; min-width: 450px;">
                      Statistics <button id="buttonStats" onclick="clickStats()" type="button"
                        value="up">&uarr;</button>
                    </td>
                  </tr>
                  <tr class="elemStatsRow">
                    <td class="centered elemStats no-margin" colspan="12" style="height: 460px;">
                      <div><canvas id="myChart" width="450" height="450" class="centered"></canvas></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </tr>
      <tr>
        <td class="colored centered" colspan="12">
          Explanations <button id="buttonExplanation" onclick="clickExplanation()" type="button"
            value="down">&darr;</button>
        </td>
      </tr>
      <tr class="elementExplanationRow centered">
        <td class="elementExplanation" colspan="12">
          <div class="explanationContent" style="margin: 0 auto;">
            <h1 style="text-align: left;">What is this project ?</h1>
            <p>
              We want to find the right parameters for a vehciule to survive as long as possible. Let say that more than
              2 minutes of survival would be a proof that the solution we are applying is giving positive signs of
              advancement.
            </p>
            <img src="image-example-1.png">
            Here is a car in front of obstacles, detecting the first one of them and the road boarders throught its
            captors. The information given by the captors are the input of a function that give to the car a direction
            to follow.
            <p>
            <div class="centered" style="margin-top: 10px; margin-bottom: 10px;">\(S(i_1, i_2, i_3, i_4, i_5) =
              \frac{1}{1 + e^{i_1w_1 + i_2w_2 + i_3w_3 + i_4w_4 + i_5w_5}}\)</div>
            </p>
            <p>
              This is the function used by cars to drive. The weights \(w_1\), \(w_2\), \(w_3\), \(w_4\), \(w_5\) are
              what we want to optimize. We want to find a value for each of them that give the better output as
              possible, so indicate a safe position that must be reached by the vehicule to survive.
            </p>
            <h1 style="text-align: left;">What solution could we use ?</h1>
            <p>
              <a href="https://en.wikipedia.org/wiki/Genetic_algorithm" target="_blank">Genetic Algorithm</a> could help
              us here to get a good solution.<br>
              This algortihm is directly inspired by evolutionary principles : we will select best parameters into a
              given generation, and favorize them to spread into the next one. <br>
              The first generation of cars are generated with random weights. We will measure their efficency, also
              named fitness, that is here define as the time that the vehicule survive.<br>
              We want that the fittest cars are more likely to be selected to give their paramaters. <br>
              There is many methods to do this and here is two of them that we could choose in our simulation : <br>
              <br>
            <table class="centered">
              <thead>
                <tr>
                  <th colspan=12>
                    <h3>Normalized fitness</h3>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="mid-colored" colspan=4>car n°</td>
                  <td class="mid-colored" colspan=4>survival time</td>
                  <td class="mid-colored" colspan=4>probability</td>
                </tr>
                <tr>
                  <td colspan=4>1</td>
                  <td colspan=4>25</td>
                  <td colspan=4>0.25</td>
                </tr>
                <tr>
                  <td colspan=4>2</td>
                  <td colspan=4>10</td>
                  <td colspan=4>0.10</td>
                </tr>
                <tr>
                  <td colspan=4>3</td>
                  <td colspan=4>20</td>
                  <td colspan=4>0.20</td>
                </tr>
                <tr>
                  <td colspan=4>4</td>
                  <td colspan=4>5</td>
                  <td colspan=4>0.05</td>
                </tr>
                <tr>
                  <td colspan=4>5</td>
                  <td colspan=4>40</td>
                  <td colspan=4>0.40</td>
                </tr>
              </tbody>
            </table>
            <br>
            <table class="centered">
              <thead>
                <tr>
                  <th colspan=12>
                    <h3>Rank</h3>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="mid-colored" colspan=4>car n°</td>
                  <td class="mid-colored" colspan=4>rank</td>
                  <td class="mid-colored" colspan=4>probability</td>
                </tr>
                <tr>
                  <td colspan=4>1</td>
                  <td colspan=4>2</td>
                  <td colspan=4>0.27</td>
                </tr>
                <tr>
                  <td colspan=4>2</td>
                  <td colspan=4>4</td>
                  <td colspan=4>0.14</td>
                </tr>
                <tr>
                  <td colspan=4>3</td>
                  <td colspan=4>3</td>
                  <td colspan=4>0.20</td>
                </tr>
                <tr>
                  <td colspan=4>4</td>
                  <td colspan=4>5</td>
                  <td colspan=4>0.06</td>
                </tr>
                <tr>
                  <td colspan=4>5</td>
                  <td colspan=4>1</td>
                  <td colspan=4>0.33</td>
                </tr>
              </tbody>
            </table>
            <br>
            We could notice that the method based on rank is a bit more balanced. It could help us to give more chance
            to vehicule with low fitness. The advantge is whith vehicules that have mostly poor paramters but one very
            good, we don't want to loose this paramters by avoiding these vehicule to have a chance give this parameters
            to descendents.<br>
            <br>
            In addition, it is important that some mutation could happend time to time. In contrary, too many of these
            mutations could cause instability and lose in the heritage. We could control the rate of these mutation into
            the parameters panel.<br>
            <br>
            A larger population improove the performance of the algorithm. <br>
            This result is similar to throwing a dice : with one dice, we only have 1/6 probability to get a 6, but
            throw hundreds of dice and the probability to get at least one 6 is higger.<br>
            However, as our computers have to run the simulation, it may be difficult to manage too many vehicules at
            the same time. We have to find a compromise for this specific parameters that we could also set into the
            associated panel.<br>
            </p>
            <p>
            <h1>Is it working ?</h1>
            <b>YES !</b><br>
            <br>
            We may all have experienced an improovement into the top score, a proof that the algortihm set is helping us
            to find right paramters. <br>
            <br>
            <b>BUT</b><br>
            <br>
            Depending of our parameters, we may have not reached the 2 minutes goal that we fixed to ourselves, or at
            least not during the time that we ran the simulation. <br>
            It goes the same for the top score of our first generation, randomly generated that could already very high,
            40 seconds and higher for example, a lot of the process is based on luck. It could be frustating
            sometimes.<br>
            Plus, the simulation is becoming very slow as the top score is increasing. When cars are being tested, no
            new cars are genereted and if a car perform during 50 seconds when the top score is 55 seconds, this means
            that we "<em>wasted</em>" 50 seconds. Plus, as we said, the performance of our algorithm is derictly related
            to the parameters that we have set, then may we try again with other one to get better performances. <br>
            <br>
            Moreover, we could encounter some "<em>issues</em>" during our optimisation procees.
            As we could remark, there is position on the road that are safe : nothing could happen to a car that stay
            there because no obstable could get there. <br>
            <img src="image-example-2.png">
            <br>
            This picture show these particular positions. As driver, we know that we can not stay between lines like
            that, but the simulation doesn't have such rules and neither the fitness function punish this kind of
            behavior, so why a car of our simulation would do otherwise ? It is a kind of local extremum that we could
            get stuck into.<br>
            <br>
            We can also think that the cars could be imporved, with a neural network with more layers, with more
            captors, and even more that the whole simulation could be modificated to be more real, more relevant with
            obstacle spawning everywher on the road, colision between cars, cars driving on 2 axes, non linear road, and
            so on...<br>
            <br>
            All of this is true, but our main goal was to get right parameters for the cars throuhgt a genetic
            algorithm, and so did we ! &#128516<br>
            <br>
            So let's celebrate for this achievement, take a little rest for now and then, why not interesting ourselves
            into Neuro Evolving of Augmenting Topologies.
            </p>
          </div>
        </td>
      </tr>
    </tbody>

  </table>

  <script>

    function clickParam() {
      let elm = document.getElementById('buttonParam');
      if (elm.value == "up") {
        elm.value = "down";
        elm.innerHTML = "&darr;"
        let menuElementRow = document.getElementsByClassName('paramMenuRow');
        for (let i = 0; i < menuElementRow.length; i++) {
          menuElementRow[i].style.display = "none";
        }
        let menuElement = document.getElementsByClassName('paramMenu');
        for (let i = 0; i < menuElement.length; i++) {
          menuElement[i].style.display = "none";
        }
      } else {
        elm.value = "up";
        elm.innerHTML = "&uarr;"
        let menuElementRow = document.getElementsByClassName('paramMenuRow');
        for (let i = 0; i < menuElementRow.length; i++) {
          menuElementRow[i].style.display = "table-row";
        }
        let menuElement = document.getElementsByClassName('paramMenu');
        for (let i = 0; i < menuElement.length; i++) {
          menuElement[i].style.display = "table-cell";
        }
      }
    }

    function clickStats() {
      let elm = document.getElementById('buttonStats');
      if (elm.value == "up") {
        elm.value = "down";
        elm.innerHTML = "&darr;"
        let statElementRow = document.getElementsByClassName('elemStatsRow');
        for (let i = 0; i < statElementRow.length; i++) {
          statElementRow[i].style.display = "none";
        }
        let statElement = document.getElementsByClassName('elemStats');
        for (let i = 0; i < statElement.length; i++) {
          statElement[i].style.display = "none";
        }
      } else {
        elm.value = "up";
        elm.innerHTML = "&uarr;"
        let statElementRow = document.getElementsByClassName('elemStatsRow');
        for (let i = 0; i < statElementRow.length; i++) {
          statElementRow[i].style.display = "table-row";
        }
        let statElement = document.getElementsByClassName('elemStats');
        for (let i = 0; i < statElement.length; i++) {
          statElement[i].style.display = "table-cell";
        }
      }
    }

    function clickExplanation() {
      let elm = document.getElementById('buttonExplanation');
      if (elm.value == "up") {
        elm.value = "down";
        elm.innerHTML = "&darr;"
        let statElementRow = document.getElementsByClassName('elementExplanationRow');
        for (let i = 0; i < statElementRow.length; i++) {
          statElementRow[i].style.display = "none";
        }
        let statElement = document.getElementsByClassName('elementExplanation');
        for (let i = 0; i < statElement.length; i++) {
          statElement[i].style.display = "none";
        }
      } else {
        elm.value = "up";
        elm.innerHTML = "&uarr;"
        let statElementRow = document.getElementsByClassName('elementExplanationRow');
        for (let i = 0; i < statElementRow.length; i++) {
          statElementRow[i].style.display = "table-row";
        }
        let statElement = document.getElementsByClassName('elementExplanation');
        for (let i = 0; i < statElement.length; i++) {
          statElement[i].style.display = "table-cell";
        }
      }
    }

    function clickPlayPause() {
      if (gameState == 1) {
        pauseTab.toggle();
        if (pauseTab.isPlaying()) {
          watch.setDelay(Date.now() - watch.getDelay());
          watch.addDelay();
        } else {
          watch.setDelay(Date.now());
        }
      } else {
        document.getElementById('buttonPlayPause').checked = "true";
      }
    }

    function clickNormalDebug() {
      debugMode = !debugMode;
      clickPlayPause();
    }

    function slideChange() {
      document.getElementById('sliderValue').innerHTML = document.getElementById('sliderMutation').value;
      mutationRate = document.getElementById('sliderMutation').value;
      console.log("Mutation Rate : " + mutationRate);
    }

    function fitnessModeChange() {
      switch (document.getElementById('fitnessMode').value) {
        case "normalized fitness":
          fitnessMode = 1;
          break;
        case "rank":
          fitnessMode = 2;
          break;
      }
      console.log(fitnessMode);
    }

    function parentsModeChange() {
      switch (document.getElementById('parentsMode').value) {
        case "best of the previous generation":
          parentsMode = 1;
          break;
        case "best of all time":
          parentsMode = 2;
          break;
      }
      console.log(parentsMode);
    }

    function carNumberChange() {
      carNumber = document.getElementById('carNumber').value;
      console.log("carNumber : " + carNumber);
    }

  </script>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.3.1/lib/p5.js"></script>
  <script src="sketch.js"></script>
  <script src="htmlRequest.js"></script>
  <script src="setgame.js"></script>
  <script src="playgame.js"></script>
  <script src="gamearea.js"></script>
  <script src="boundaries.js"></script>
  <script src="obstacles.js"></script>
  <script src="variables.js"></script>
  <script src="cars.js"></script>
  <script src="ray.js"></script>
  <script src="neurons.js"></script>
  <script src="startgame.js"></script>
  <script src="functions.js"></script>
  <script src="clocks.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script src="stats.js"></script>
  <script src="start.js"></script>
  <script src="pauseGame.js"></script>
  <script src="dispScore.js"></script>
  <script src="geneticAlgorithm.js"></script>
  <script src="tree.js"></script>
  <script src="scoreboard.js"></script>
  <script src="aliveBoard.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</body>

</html>